<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Etiqueta Generada</title>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #eef2fb;
    color: #1e1e1e;
  }

  .hero {
    background: linear-gradient(135deg, #000000, #003d99);
    color: #b7d9ff;
    padding: 50px 40px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    border-bottom: 3px solid #007bff;
  }
  .hero h1 {
    font-size: 40px;
    font-weight: bold;
    margin: 0;
    text-shadow: 0 0 10px #008cff;
  }

  .container {
    max-width: 900px;
    margin: 40px auto;
    background: #ffffff;
    padding: 28px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid #dfe6f5;
  }

  h2 {
    color: #004a99;
    font-size: 26px;
    margin-top: 0;
    text-align: center;
  }

  .etiqueta-wrapper {
    display:flex;
    justify-content:center;
    margin-bottom:20px;
  }

  #contenedorEtiqueta {
    width: 820px;
    border: 2px solid black;
    padding: 20px;
    font-family: Arial;
    font-size: 15px;
    background: white;
  }

  .img-pictograma {
    max-width: 100%;
    height: auto;
    object-fit: contain;
  }

  .controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }

  input[type="number"] {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #c9c9c9;
    background: #f9f9f9;
  }

  button {
    background: #007bff;
    padding: 12px 18px;
    border: none;
    color: #fff;
    font-size: 15px;
    border-radius: 6px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }

  button.secondary {
    background: #6c757d;
  }

  .small {
    font-size: 13px;
    color: #444;
  }

  #status {
    margin-top:10px;
    font-size:14px;
    color:#333;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>
<div class="hero"><h1>Etiqueta Generada</h1></div>

<div class="container">
<h2>Vista previa de la etiqueta</h2>

<div class="etiqueta-wrapper">
  <div id="contenedorEtiqueta">
    <div style="display: grid; grid-template-columns: 1fr 30px 35%; column-gap: 0;">
      <div style="grid-column: 1;">
        <div id="proveedorInfo" style="font-size:14px;">
            <strong>Proveedor:</strong> <span id="displayFabricante"></span></p>
        </div>
      </div>
      <div style="grid-column: 2;"></div>
      <div style="grid-column: 3; text-align:center;">
        <strong>Pictogramas de<br>Peligro</strong>
      </div>
      <div style="grid-column: 1; margin-top:14px;">
        <hr style="border:1px solid black; margin:0;">
      </div>
      <div style="grid-column: 1; margin-top:20px;">
        <strong style="font-size: 17px;" id="nombreReactivo">NOMBRE DEL REACTIVO</strong>
        <br><br>
        <p><strong>Preparaci贸n:</strong></p>
        <p id="preparacion">DESCRIPCIN DEL REACTIVO O PREPARACIN</p>
        <p><strong>ADVERTENCIA: <span id="advertencia">ATENCIN</span></strong></p>
        <div id="frasesHP"></div>
      </div>
      <div style="grid-column: 3; text-align: center; min-height: 300px; display:flex; flex-direction:column; align-items:center;">
        <div id="zonaPictogramas"
             style="min-height: 220px; display:flex; justify-content:center; align-items:center; margin-bottom:10px;"></div>
        <img id="qrCarpetaDrive" src="" alt="C贸digo QR Carpeta Drive"
             style="width:150px; margin-top:10px; border: 1px solid #ccc;">
      </div>
      <div style="grid-column: 1; margin-top:20px;">
        <hr style="border:1px solid black; margin:0;">
      </div>
      <div style="grid-column: 1; margin-top:20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; column-gap: 40px;">
          <div>
            <strong>Fecha Preparado:</strong><br>
            <span id="fechaPreparado">DD/MM/YYYY</span>
          </div>
          <div style="text-align: right;">
            <strong>Fecha Vencimiento:</strong><br>
            <span id="fechaVencimiento">DIA/MES/AO</span>
          </div>
        </div>
        <div style="margin-top:18px;">
          <strong>Preparado por:</strong><br>
          <span id="analista">ANALISTA DE LABORATORIO</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="controls">
  <div>
    <label class="small">Cantidad de etiquetas a generar:</label>
    <input id="inputCantidad" type="number" min="1" value="1" />
  </div>

  <div>
    <label class="small">(Opcional) Nombre archivo:</label>
    <input id="nombreArchivo" type="text" placeholder="etiquetas" />
  </div>
</div>

<div style="display:flex; gap:10px; margin-top:12px;">
  <button id="btnCapturar" type="button">Capturar etiqueta y generar documento</button>
  <button id="btnPreview" class="secondary" type="button">Descargar archivo DOCX</button>
</div>

<div id="status"></div>
</div>


<script type="module">
  import { API_URL } from "./config.js";

  // Variables globales
  const statusEl = document.getElementById("status");
  const contenedor = document.getElementById("contenedorEtiqueta");
  const btn = document.getElementById("btnCapturar");
  const btnPreview = document.getElementById("btnPreview");
  let envase = ""; // Variable global para compartir entre cargarDatos y el bot贸n

  function setStatus(msg, isError=false) {
    statusEl.textContent = msg;
    statusEl.style.color = isError ? "#b20000" : "#0b5";
  }

  // =======================================================
  // FUNCIN PRINCIPAL DE CARGA DE DATOS (CORREGIDA)
  // =======================================================
  async function cargarDatos() {
    console.log(" Ejecutando cargarDatos (Pageshow/Load)");

    const datos = JSON.parse(sessionStorage.getItem("datosEtiqueta") || "{}");
    if (!datos.usuario || !datos.reactivo) {
      setStatus("No se pudo cargar la informaci贸n del reactivo.", true);
      return;
    }

    const { nombreReactivo, analista, vigenciaValor, vigenciaUnidad, incluirFechas } = datos.usuario || {};
    envase = (datos.usuario && datos.usuario.envase) || (datos.reactivo && datos.reactivo.volumen) || "";

    const { preparaci贸n, palabra_advertencia, frases_h, frases_p, imagenPictograma } = datos.reactivo || {};


    
    const proveedorEl = document.getElementById("displayFabricante");

    if (datos.usuario.modoReactivosPuros) {
        // 1. Extraemos los datos (si no existen, ponemos texto vac铆o)
        const fabricante = datos.usuario.fabricante || "";
        const direccion = datos.reactivo.direccion || "";
        const telefono = datos.reactivo.telefono || "";

        // 2. Armamos la cadena completa con separadores
        // Usamos el operador "&&" para solo a帽adir comas/espacios si el dato existe
        let infoCompleta = fabricante;
        if (direccion) infoCompleta += " - " + direccion;
        if (telefono) infoCompleta += " - Tel: " + telefono;

        // 3. Lo inyectamos en el HTML
        proveedorEl.textContent = infoCompleta;

        // 4. Ajuste autom谩tico de tama帽o para que no se desborde si el texto es largo
        if (infoCompleta.length > 80) {
            proveedorEl.parentElement.style.fontSize = "10px";
        } else if (infoCompleta.length > 50) {
            proveedorEl.parentElement.style.fontSize = "12px";
        }
    } else {
        // Modo soluciones preparadas (Proveedor de la casa)
        proveedorEl.textContent = "SGI SAS - Cra. 32B #22B-29 - Tel: 3142742383";
    }



    // 1. Asignar Textos
    document.getElementById("nombreReactivo").textContent = nombreReactivo || "NOMBRE DEL REACTIVO";
    document.getElementById("analista").textContent = analista || "ANALISTA DE LABORATORIO";
    document.getElementById("preparacion").textContent = preparaci贸n || "No aplica";
    document.getElementById("advertencia").textContent = palabra_advertencia || "No definida";

    // 2. Manejo de Fechas
    const spanPreparado = document.getElementById("fechaPreparado");
    const spanVencimiento = document.getElementById("fechaVencimiento");

    if (incluirFechas) {
      spanPreparado.style.display = "inline"; // Asegurar que se muestren
      spanVencimiento.style.display = "inline";
      
      const hoy = new Date();
      spanPreparado.textContent = hoy.toLocaleDateString("es-CO");

      let venc = new Date(hoy);
      switch (vigenciaUnidad) {
        case "D铆a(s)": venc.setDate(venc.getDate() + parseInt(vigenciaValor || 0)); break;
        case "Semana(s)": venc.setDate(venc.getDate() + parseInt(vigenciaValor || 0) * 7); break;
        case "Mes(es)": venc.setMonth(venc.getMonth() + parseInt(vigenciaValor || 0)); break;
        case "A帽o(s)": venc.setFullYear(venc.getFullYear() + parseInt(vigenciaValor || 0)); break;
      }
      spanVencimiento.textContent = venc.toLocaleDateString("es-CO");
    } else {
      spanPreparado.style.display = "none";
      spanVencimiento.style.display = "none";
    }

    // 3. Frases H y P
    let htmlHP = "";
    if (frases_h) frases_h.forEach(f => htmlHP += `<p style="margin: 2px 0;">${f}</p>`);
    if (frases_p) frases_p.forEach(f => htmlHP += `<p style="margin: 2px 0;">${f}</p>`);
    document.getElementById("frasesHP").innerHTML = htmlHP;

    // 4. IMGENES: REINICIO Y CARGA (Soluci贸n al bug visual)
    const zonaImg = document.getElementById("zonaPictogramas");
    const qrElemento = document.getElementById('qrCarpetaDrive');

    // -- Paso Cr铆tico: Limpiar fuentes primero para forzar repintado --
    zonaImg.innerHTML = "";
    qrElemento.src = "";
    
    // Usamos setTimeout para dar tiempo al navegador de limpiar el buffer gr谩fico
    setTimeout(() => {
        // Pintar Pictogramas
        if (imagenPictograma) {
           zonaImg.innerHTML = `<img src="${imagenPictograma}" class="img-pictograma" alt="pictogramas">`;
        }

        // Generar/Pintar QR
        if (nombreReactivo && analista) {
            generarQRdeCarpeta(nombreReactivo, analista);
        }
    }, 50); // 50ms de retraso es imperceptible pero suficiente
  }

  // Funci贸n auxiliar para el QR
  // Busca la funci贸n generarQRdeCarpeta (alrededor de la l铆nea 275) y reempl谩zala:
async function generarQRdeCarpeta(nombre, analista) {
  const url = `${API_URL}/api/procesarCarpetaReactivo`;
  const qrElemento = document.getElementById('qrCarpetaDrive');
  
  // Obtenemos los datos guardados para saber el modo y fabricante
  const datos = JSON.parse(sessionStorage.getItem("datosEtiqueta") || "{}");
  const { modoReactivosPuros, fabricante } = datos.usuario || {};

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', "ngrok-skip-browser-warning": "true"},
      body: JSON.stringify({ 
        nombreReactivo: nombre, 
        usuarioAnalista: analista,
        modoReactivosPuros: modoReactivosPuros, // <--- AHORA EL SERVIDOR SABR DNDE BUSCAR
        fabricante: fabricante 
      })
    });

    if (!response.ok) {
        console.error("Error en servidor al generar QR:", response.status);
        return;
    }

    const data = await response.json();
    if (data.qr) qrElemento.src = data.qr;

  } catch (e) {
    console.error("Fallo la conexi贸n para el QR:", e);
  }
}

  // =======================================================
  // EVENTO PAGESHOW: LA CLAVE PARA ARREGLAR EL BOTN "ATRS"
  // =======================================================
  window.addEventListener("pageshow", (event) => {
      // Llamamos a cargarDatos cada vez que la p谩gina se muestra
      // Esto sobreescribe cualquier estado visual corrupto del cach茅
      cargarDatos();
  });


  // =======================================================
  // BOTN DE DESCARGA DOCX
  // =======================================================
  btnPreview.addEventListener("click", async () => {
    if (!window.__ultimoArchivoGenerado) {
        setStatus("No hay archivo generado. Genera el documento primero.", true);
        return;
    }
    
    setStatus("Iniciando descarga DOCX...");

    const archivo = window.__ultimoArchivoGenerado;
    const urlDescarga = `${API_URL}/api/descargar/${archivo}`;
    
    try {
        const response = await fetch(urlDescarga, {
            method: 'GET',
            headers: { 
                'ngrok-skip-browser-warning': 'true' 
            }
        });

        if (!response.ok) {
            setStatus("Error al descargar el archivo. C贸digo: " + response.status, true);
            return;
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = archivo; 
        document.body.appendChild(a);
        a.click();
        a.remove(); 
        window.URL.revokeObjectURL(url);

        setStatus("Archivo DOCX descargado correctamente.");

    } catch (error) {
        console.error("Error en la descarga:", error);
        setStatus("Fallo la descarga. Revisa la conexi贸n o consola.", true);
    }
  });

  // =======================================================
  // BOTN GENERAR (Captura HTML2Canvas)
  // =======================================================
  btn.addEventListener("click", async (e) => {
    e.preventDefault();
    console.log(" CLICK EN BOTN AZUL DETECTADO");
    setStatus("Capturando etiqueta...");

    const cantidad = parseInt(document.getElementById("inputCantidad").value || "0", 10);
    if (!cantidad || cantidad <= 0) {
      setStatus("Cantidad inv谩lida.", true);
      return;
    }

    try {
      const canvas = await html2canvas(contenedor, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff"
      });

      const dataUrl = canvas.toDataURL("image/png");
      const base64 = dataUrl.replace(/^data:image\/png;base64,/, "");

      setStatus("Enviando imagen al servidor...");

      const res = await fetch(`${API_URL}/api/generarDocumentoEtiquetas`, {
        method: "POST",
        headers: { "Content-Type": "application/json","ngrok-skip-browser-warning": "true" },
        body: JSON.stringify({
          base64Imagen: base64,
          cantidad,
          envase
        })
      });

      if (!res.ok) {
        const err = await res.json().catch(()=>({error:"Error desconocido"}));
        setStatus("Error generando documento: " + (err.error || res.statusText), true);
        return;
      }

      setStatus("Recibiendo documento...");

      const respuesta = await res.json();
      if (!respuesta.ok || !respuesta.archivo) {
         setStatus("Error: No se recibi贸 nombre del archivo generado.", true);
         return; 
      }

      window.__ultimoArchivoGenerado = respuesta.archivo;
      setStatus("Documento generado correctamente. Ahora puedes descargarlo con el bot贸n gris.");

    } catch (err) {
      console.error(err);
      setStatus("Error generando documento. Revisa la consola.", true);
    }
  });

</script>

</body>
</html>