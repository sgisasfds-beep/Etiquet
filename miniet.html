<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Etiqueta Generada</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #eef2fb;
            color: #1e1e1e;
        }

        .hero {
            background: linear-gradient(135deg, #000000, #003d99);
            color: #b7d9ff;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border-bottom: 3px solid #007bff;
        }

        .hero h1 {
            font-size: 42px;
            font-weight: bold;
            text-shadow: 0 0 10px #008cff;
            margin: 0;
        }

        .container {
            max-width: 960px;
            margin: 40px auto;
            background: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid #dfe6f5;
            text-align: center;
        }

        h2 {
            color: #004a99;
            font-size: 26px;
            margin-top: 0;
        }

        .etiqueta {
            width: 500px;
            height: 350px;
            margin: 30px auto;
            border: 3px solid black;
            padding: 15px;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
            background-color: white;
        }

        .etiqueta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto auto;
            gap: 8px 0;
            height: 100%;
            align-items: start;
        }

        .header-left {
            grid-column: 1 / 3;
            text-align: left;
            font-size: 10px;
            font-weight: bold;
            padding-bottom: 6px;
            border-bottom: 2px solid black;
        }

        .header-right {
            display: none;
        }

        .content-row {
            grid-column: 1 / 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 6px;
            flex: 1;
        }

        .reactivo-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #000;
            text-align: center;
            line-height: 1.15;
            max-height: 60px;
            overflow: hidden;
            word-break: break-word;
        }

        .cajas-row {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 4px;
        }

        .box {
            width: 150px;
            height: 150px;
            background-color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            padding: 5px;
        }

        .box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        #pictogramaBox {
            width: 180px !important;
            height: 180px !important;
            margin-top: -10px;
        }

        #qrBox {
            width: 150px !important;
            height: 150px !important;
        }

        .footer-line {
            grid-column: 1 / 3;
            border-top: 2px solid black;
            margin-top: 6px;
        }

        /* üî• PROVEEDOR M√ÅS GRANDE */
        .footer-proveedor {
            grid-column: 1 / 3;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            padding-top: 4px;
            line-height: 1.2;
            word-break: break-word;
        }

        button {
            background: #6c757d;
            padding: 14px 26px;
            border: none;
            width: 100%;
            max-width: 300px;
            color: #fff;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            margin-top: 20px;
        }

        button:hover {
            background: #5a6268;
            transform: scale(1.03);
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>

    <div class="hero">
        <h1>Etiqueta Generada</h1>
    </div>

    <div class="container">
        <h2>Vista previa de la etiqueta</h2>

        <div class="etiqueta">
            <div class="etiqueta-grid">

                <div class="header-left">
                    ADVERTENCIA: <span id="advertenciaTexto">ATENCION</span>
                </div>

                <div class="header-right"></div>

                <div class="content-row">
                    <div class="reactivo-name" id="nombreReactivo">REACTIVO</div>

                    <div class="cajas-row">
                        <div class="box" id="pictogramaBox">PICTOGRAMA</div>
                        <div class="box" id="qrBox">C√ìDIGO QR</div>
                    </div>
                </div>

                <div class="footer-line"></div>

                <div class="footer-proveedor">
                    Proveedor: <span id="proveedorTexto">SGI SAS Cra. 32B #22B - 29 TEL: 3142742383</span>
                </div>

            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:12px;justify-content:center; width:100%;">
            <button id="btnCapturar" type="button">Capturar etiqueta y generar documento</button>
            <button id="btnPreview" class="secondary" type="button">Descargar archivo DOCX</button>
        </div>

        <button onclick="window.location.href='index.html'">Volver al formulario</button>
        <p id="status"></p>

    </div>

    <script type="module">
        import { API_URL } from "./config.js";

        const statusEl = document.getElementById("status");

        const datosJSON = sessionStorage.getItem("datosEtiqueta");
        const datosEtiqueta = datosJSON ? JSON.parse(datosJSON) : null;

        let nombreReactivo = "";
        let analista = "";
        let ultimoArchivoGenerado = null;

        if (!datosEtiqueta) {
            statusEl.textContent = "‚ùå Error: No se encontraron datos de la etiqueta. Vuelve al formulario.";
            statusEl.style.color = "red";
            document.getElementById("nombreReactivo").textContent = "ERROR AL CARGAR DATOS";
        } else {
            statusEl.textContent = "‚úÖ Etiqueta cargada correctamente.";
            statusEl.style.color = "green";

            nombreReactivo = datosEtiqueta.usuario.nombreReactivo;
            analista = datosEtiqueta.usuario.analista;
            const envase = datosEtiqueta.usuario.envase;
            const fabricante = datosEtiqueta.usuario.fabricante;
            const palabra_advertencia = datosEtiqueta.reactivo.palabra_advertencia;

            document.getElementById("nombreReactivo").textContent = nombreReactivo.toUpperCase();
            const proveedorSpan = document.getElementById("proveedorTexto");

            if (datosEtiqueta.usuario.modoReactivosPuros) {

                const proveedor = datosEtiqueta.reactivo.proveedor || "";
                const direccion = datosEtiqueta.reactivo.direccion || "";
                const telefono = datosEtiqueta.reactivo.telefono || "";

                let textoProveedor = `${proveedor} ${direccion} Tel: ${telefono}`.trim();

                proveedorSpan.textContent = textoProveedor;

                // Ajustar tama√±o si es muy largo (igual que etiqueta grande)
                if (textoProveedor.length > 90) {
                    proveedorSpan.style.fontSize = "9px";
                } else if (textoProveedor.length > 70) {
                    proveedorSpan.style.fontSize = "10px";
                } else {
                    proveedorSpan.style.fontSize = "11px";
                }

            } else {

                proveedorSpan.textContent =
                "SGI SAS Cra. 32B #22B - 29 TEL: 3142742383";
            }

            document.getElementById("advertenciaTexto").textContent = (palabra_advertencia || "ATENCI√ìN").toUpperCase();

            async function cargarPictograma() {
                const pictogramaBox = document.getElementById("pictogramaBox");
                if (!pictogramaBox.innerHTML.includes('img')) {
                    pictogramaBox.textContent = "Cargando...";
                }

                try {
                    const res = await fetch(`${API_URL}/api/generarEtiqueta`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "ngrok-skip-browser-warning": "true"
                        },
                        body: JSON.stringify({
                            nombreReactivo,
                            fabricante,
                            volumen: envase
                        })
                    });

                    if (!res.ok) {
                        pictogramaBox.textContent = "Error al generar pictograma";
                        return;
                    }

                    const data = await res.json();

                    if (data.imagenPictograma) {
                        pictogramaBox.innerHTML = "";
                        setTimeout(() => {
                            pictogramaBox.innerHTML = `<img src="${data.imagenPictograma}" alt="pictograma">`;
                        }, 50);
                    } else {
                        pictogramaBox.textContent = "NO PICTOGRAMA";
                    }

                } catch (error) {
                    console.error(error);
                    pictogramaBox.textContent = "Error de conexi√≥n";
                }
            }

            const qrBox = document.getElementById("qrBox");

            async function generarQRdeCarpeta(nombre, analista) {
                if (!qrBox.innerHTML.includes('img')) {
                    qrBox.textContent = "Generando QR...";
                }
                const url = `${API_URL}/api/procesarCarpetaReactivo`;

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "ngrok-skip-browser-warning": "true"
                        },
                        body: JSON.stringify({ nombreReactivo: nombre, usuarioAnalista: analista })
                    });

                    if (!response.ok) throw new Error("Error servidor QR");

                    const data = await response.json();

                    if (data.qr) {
                        sessionStorage.setItem("qr_generado_miniet", data.qr);
                        pintarQR(data.qr);
                    }

                } catch (e) {
                    console.error("Fallo la generaci√≥n de QR:", e);
                    qrBox.textContent = "Error QR";
                    qrBox.style.backgroundColor = "red";
                    qrBox.style.color = "white";
                }
            }

            function pintarQR(qrUrl) {
                qrBox.innerHTML = "";
                setTimeout(() => {
                    qrBox.innerHTML = `<img src="${qrUrl}" alt="C√≥digo QR Carpeta Drive">`;
                }, 50);
            }

            cargarPictograma();

            const qrGuardado = sessionStorage.getItem("qr_generado_miniet");
            if (qrGuardado) {
                pintarQR(qrGuardado);
            } else if (nombreReactivo && analista) {
                generarQRdeCarpeta(nombreReactivo, analista);
            }

            window.addEventListener("pageshow", (event) => {
                if (event.persisted) {
                    console.log("‚ôªÔ∏è Restaurando im√°genes tras volver...");

                    const boxPic = document.getElementById("pictogramaBox");
                    const imgPic = boxPic.querySelector('img');
                    if (imgPic) {
                        const src = imgPic.src;
                        imgPic.src = "";
                        setTimeout(() => imgPic.src = src, 10);
                    }

                    const qrG = sessionStorage.getItem("qr_generado_miniet");
                    if (qrG) {
                        pintarQR(qrG);
                    }
                }
            });
        }

        const contenedorEtiqueta = document.querySelector(".etiqueta");
        const btnGenerate = document.getElementById("btnCapturar");
        const btnDownload = document.getElementById("btnPreview");

        function setStatus(msg, isError = false) {
            statusEl.textContent = msg;
            statusEl.style.color = isError ? "red" : "green";
        }

        btnGenerate.addEventListener("click", async () => {
            setStatus("Capturando etiqueta...");
            try {
                const canvas = await html2canvas(contenedorEtiqueta, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: "#ffffff"
                });

                const dataUrl = canvas.toDataURL("image/png");
                const base64 = dataUrl.replace(/^data:image\/png;base64,/, "");

                setStatus("Enviando imagen al servidor...");

                const res = await fetch(`${API_URL}/api/generarDocumentoEtiquetas`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify({
                        base64Imagen: base64,
                        cantidad: 1,
                        envase: datosEtiqueta.usuario.envase
                    })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({ error: "Error desconocido" }));
                    setStatus("Error generando documento: " + (err.error || res.statusText), true);
                    return;
                }

                const respuesta = await res.json();
                if (!respuesta.ok || !respuesta.archivo) {
                    setStatus("Error: El servidor no devolvi√≥ un nombre de archivo.", true);
                    return;
                }

                ultimoArchivoGenerado = respuesta.archivo;
                setStatus("Documento generado correctamente. Ahora puedes descargarlo.");

            } catch (e) {
                console.error(e);
                setStatus("Error capturando la etiqueta.", true);
            }
        });

        btnDownload.addEventListener("click", async () => {
            if (!ultimoArchivoGenerado) {
                setStatus("Primero genera el documento (bot√≥n azul).", true);
                return;
            }

            setStatus("Descargando archivo...");
            const url = `${API_URL}/api/descargar/${ultimoArchivoGenerado}`;

            try {
                const response = await fetch(url, {
                    method: "GET",
                    headers: { "ngrok-skip-browser-warning": "true" }
                });

                if (!response.ok) {
                    setStatus("Error descargando archivo.", true);
                    return;
                }

                const blob = await response.blob();
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = ultimoArchivoGenerado;
                link.click();
                setStatus("Archivo DOCX descargado correctamente.");
            } catch (e) {
                console.error(e);
                setStatus("Error descargando archivo.", true);
            }
        });
    </script>

</body>
</html>
