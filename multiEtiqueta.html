<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vista previa de mÃºltiples etiquetas</title>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #eef2fb;
    color: #1e1e1e;
  }

  .hero {
    background: linear-gradient(135deg, #000000, #003d99);
    color: #b7d9ff;
    padding: 50px 40px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    border-bottom: 3px solid #007bff;
  }

  .hero h1 {
    font-size: 40px;
    font-weight: bold;
    margin: 0;
    text-shadow: 0 0 10px #008cff;
  }

  .container {
    max-width: 960px;
    margin: 40px auto;
    background: #ffffff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid #dfe6f5;
  }

  h2 {
    color: #004a99;
    font-size: 26px;
    margin-top: 0;
    text-align: center;
  }

  /* CONTENEDOR GENERAL DE TODAS LAS ETIQUETAS */
  #listaEtiquetas {
    display: flex;
    flex-direction: column;
    gap: 35px;
    align-items: center;
    margin-top: 25px;
  }

  /* FORMATO EXACTO DE TU ETIQUETA INDIVIDUAL */
  .etiqueta {
    width: 820px;
    border: 2px solid black;
    padding: 20px;
    font-family: Arial;
    font-size: 15px;
    background: white;
  }

  .img-pictograma {
    max-width: 100%;
    height: auto;
    object-fit: contain;
  }

  button {
    background: #007bff;
    padding: 12px 20px;
    border: none;
    color: #fff;
    font-size: 15px;
    border-radius: 6px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }

  button.secondary {
    background: #6c757d;
  }

  .controls {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
  }

  #status {
    margin-top: 20px;
    text-align: center;
    font-size: 15px;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

</head>
<body>

<div class="hero"><h1>Vista previa de mÃºltiples etiquetas</h1></div>

<div class="container">

  <h2>Etiquetas generadas</h2>

  <div id="listaEtiquetas"></div>

  <div class="controls">
    <button id="btnGenerarDOCX">Generar archivo DOCX</button>
    <button id="btnDescargar" class="secondary">Descargar archivo</button>
  </div>

  <div id="status"></div>

</div>

<script type="module">
import { API_URL } from "./config.js";

/* =====================================================
Â  Â Recuperar datos enviados desde multiIndex.html
===================================================== */
const datosJSON = sessionStorage.getItem("multiEtiquetas_datos");
const datos = datosJSON ? JSON.parse(datosJSON) : [];
window.datos = datos; // Guardamos en window para que sea globalmente accesible

if (datos.length === 0) {
Â  Â  console.error("No se encontraron datos de etiquetas en sessionStorage.");
Â  Â  // PodrÃ­as redirigir al usuario aquÃ­ o mostrar un mensaje
}

// â­ CAMBIO 1 (CORRECCIÃ“N): DefiniciÃ³n ÃšNICA del elemento de estatus
const statusEl = document.getElementById("status");

// â­ CAMBIO 2 (CORRECCIÃ“N): DefiniciÃ³n ÃšNICA de la funciÃ³n setStatus
function setStatus(message, isError = false) {
Â  Â  if (!statusEl) return;
Â  Â  statusEl.textContent = message;
Â  Â  statusEl.style.color = isError ? "red" : "green";
Â  Â  console.log(isError ? `[ERROR] ${message}` : `[STATUS] ${message}`);
}

/* =====================================================
Â  Â Plantilla HTML original de etiqueta (igual al index)
===================================================== */

function crearPlantillaMiniEtiqueta() {
    const div = document.createElement("div");

    div.className = "etiqueta";
    div.style.width = "500px";
    div.style.height = "350px";
    div.style.margin = "30px auto";
    div.style.border = "3px solid black";
    div.style.padding = "15px";
    div.style.boxSizing = "border-box";
    div.style.backgroundColor = "white";
    div.style.fontFamily = "Arial, sans-serif";

    div.innerHTML = `
        <div class="etiqueta-grid"
             style="display:grid;
                    grid-template-columns:1fr 1fr;
                    grid-template-rows:auto auto auto auto;
                    gap:8px 0;
                    height:100%;
                    align-items:start;">

            <!-- HEADER -->
            <div style="grid-column:1/3;
                        text-align:left;
                        font-size:10px;
                        font-weight:bold;
                        padding-bottom:6px;
                        border-bottom:2px solid black;">
                ADVERTENCIA: <span class="advertencia">ATENCION</span>
            </div>

            <!-- CONTENIDO -->
            <div style="grid-column:1/3;
                        display:flex;
                        flex-direction:column;
                        align-items:center;
                        padding-top:6px;
                        flex:1;">

                <div class="nombreReactivo"
                     style="font-size:20px;
                            font-weight:bold;
                            margin-bottom:8px;
                            text-align:center;
                            line-height:1.15;
                            max-height:60px;
                            overflow:hidden;
                            word-break:break-word;">
                    REACTIVO
                </div>

                <div style="width:100%;
                            display:flex;
                            justify-content:center;
                            gap:40px;
                            margin-top:4px;">

                    <div class="zonaPictogramas"
                         style="width:180px;
                                height:180px;
                                margin-top:-10px;
                                display:flex;
                                align-items:center;
                                justify-content:center;">
                        PICTOGRAMA
                    </div>

                    <div style="width:150px;
                                height:150px;
                                display:flex;
                                align-items:center;
                                justify-content:center;">
                        <img class="qr"
                             src=""
                             style="max-width:100%;
                                    max-height:100%;
                                    object-fit:contain;">
                    </div>

                </div>
            </div>

            <!-- LINEA DIVISORIA -->
            <div style="grid-column:1/3;
                        border-top:2px solid black;
                        margin-top:6px;">
            </div>

            <!-- FOOTER FABRICANTE -->
            <div class="footer-proveedor"
                style="grid-column:1/3;
                padding-top:6px;">

                <div style="display:flex;
                    align-items:center;
                    width:100%;
                    font-size:11px;
                    font-weight:bold;">

                  <span style="margin-right:6px; white-space:nowrap;">
                      Fabricante:
                  </span>

                  <div class="fabricante-wrapper"
                        style="flex:1; overflow:hidden;">

                        <span class="fabricante-text"
                              style="display:inline-block;
                                    white-space:nowrap;
                                    transform-origin:left center;">
                        </span>

                  </div>

                </div>

            </div>


        </div>

        <!-- DATOS OCULTOS -->
        <div style="display:none;">
            <span class="preparacion"></span>
            <span class="analista"></span>
            <span class="fechaPreparado"></span>
            <span class="fechaVencimiento"></span>
            <div class="frasesHP"></div>
        </div>
    `;

    return div;
}


function crearPlantillaEtiqueta() {

  const div = document.createElement("div");
  div.className = "etiqueta";

  div.innerHTML = `

    <div style="display:grid; grid-template-columns: 1fr 30px 35%; column-gap:0;">

      <!-- FABRICANTE -->
      <div style="grid-column:1;">
        <div style="display:flex; align-items:center; width:100%;">

          <strong style="margin-right:6px; white-space:nowrap;">
            Fabricante:
          </strong>

          <div class="fabricante-wrapper"
                style="flex:1; overflow:hidden;">

            <span class="fabricante-text"
                  style="display:inline-block;
                         white-space:nowrap;
                         transform-origin:left center;">
            </span>

          </div>

        </div>
      </div>

      <!-- TÃTULO PICTOGRAMAS -->
      <div style="grid-column:3; text-align:center;">
        <strong>Pictogramas de<br>Peligro</strong>
      </div>

      <!-- LINEA -->
      <div style="grid-column:1; margin-top:14px;">
        <hr style="border:1px solid black; margin:0;">
      </div>

      <!-- INFORMACIÃ“N REACTIVO -->
      <div style="grid-column:1; margin-top:20px;">
        <strong style="font-size:17px;" class="nombreReactivo">NOMBRE</strong>
        <br><br>

        <p><strong>PreparaciÃ³n:</strong></p>
        <p class="preparacion">---</p>

        <p><strong>ADVERTENCIA: <span class="advertencia">---</span></strong></p>

        <div class="frasesHP"></div>
      </div>

      <!-- ZONA DERECHA (PICTOGRAMAS + QR) -->
      <div style="
            grid-column:3;
            text-align:center;
            min-height:300px;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:flex-start;
          ">

        <!-- ğŸ”¥ ZONA BLINDADA DE PICTOGRAMAS -->
        <div class="zonaPictogramas"
             style="
                width:100%;
                max-width:100%;
                min-height:220px;
                max-height:220px;
                overflow:hidden;
                display:flex;
                flex-wrap:wrap;
                justify-content:center;
                align-items:center;
                gap:6px;
             ">
        </div>

        <!-- QR -->
        <img class="qr"
             src=""
             style="
                width:150px;
                max-width:100%;
                height:auto;
                border:1px solid #ccc;
                margin-top:10px;
             ">
      </div>

      <!-- LINEA -->
      <div style="grid-column:1; margin-top:20px;">
        <hr style="border:1px solid black; margin:0;">
      </div>

      <!-- FECHAS -->
      <div style="grid-column:1; margin-top:20px;">

        <div style="display:grid; grid-template-columns:1fr 1fr; column-gap:40px;">

          <div>
            <strong>Fecha Preparado:</strong><br>
            <span class="fechaPreparado">DD/MM/YYYY</span>
          </div>

          <div style="text-align:right;">
            <strong>Fecha Vencimiento:</strong><br>
            <span class="fechaVencimiento">DD/MM/YYYY</span>
          </div>

        </div>

        <div style="margin-top:18px;">
          <strong>Preparado por:</strong><br>
          <span class="analista">---</span>
        </div>

      </div>

    </div>
  `;

  return div;
}



/* =====================================================
Â  Â Renderizar TODAS las etiquetas solicitadas
===================================================== */
async function cargarEtiquetas() {
Â  const contenedor = document.getElementById("listaEtiquetas");
Â  // const statusEl = document.getElementById("status"); // << YA ESTÃ DEFINIDO ARRIBA

Â  // Mostrar mensaje de carga porque esto tardarÃ¡ unos segundos creando carpetas
Â  setStatus("Generando carpetas y QRs en Google Drive, por favor espera...", false); // Usando setStatus

Â  for (const item of datos) {

Â  Â  // 1. Obtener Datos Visuales (Pictogramas, Frases H/P)
Â  Â  const resVisual = await fetch(`${API_URL}/api/generarEtiqueta`, {
Â  Â  Â  method: "POST",
Â  Â  Â  headers: {"Content-Type": "application/json","ngrok-skip-browser-warning": "true"},
Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  nombreReactivo: item.nombreReactivo,
Â  Â  Â  Â  fabricante: item.fabricante,
Â  Â  Â  Â  volumen: item.envase,
        modoReactivosPuros: item.soloPuros
Â  Â  Â  })
Â  Â  });
Â  Â  const info = await resVisual.json();

    console.log("INFO BACKEND:", info);


Â  Â  // 2. GENERAR LA CARPETA Y EL QR ÃšNICO (Esta es la parte que faltaba)
Â  Â  // Llamamos al endpoint que crea la carpeta en Drive y nos devuelve el QR
Â  Â  let qrBase64 = "";
Â  Â  try {
Â  Â  Â  Â  const resQR = await fetch(`${API_URL}/api/procesarCarpetaReactivo`, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json", "ngrok-skip-browser-warning": "true" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  nombreReactivo: item.nombreReactivo,
Â  Â  Â  Â  Â  Â  Â  Â  usuarioAnalista: item.analista,
                fabricante: item.fabricante,
                modoReactivosPuros: item.soloPuros
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });
Â  Â  Â  Â  const dataQR = await resQR.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (dataQR.ok) {
Â  Â  Â  Â  Â  Â  qrBase64 = dataQR.qr; // AquÃ­ recibimos el QR Ãºnico de la nueva carpeta
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error("Error generando QR:", dataQR.error);
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Error conectando para QR:", err);
Â  Â  }

Â  Â  if (!resVisual.ok) continue;

Â  Â  const copias = item.copias || 1;

Â  Â  // 3. Renderizar las copias (Mismo QR para las copias del mismo formulario)
Â  Â  for (let c = 0; c < copias; c++) {

Â  Â  Â  const envaseMini = ["30","30 mL","40", "40 mL","60", "60 mL"];

      let et;
      if (envaseMini.includes(item.envase)) {
          et = crearPlantillaMiniEtiqueta();  // NUEVA PLANTILLA MINI
      } else {
          et = crearPlantillaEtiqueta();      // TU PLANTILLA NORMAL
      }

Â  Â  Â  // Llenar datos visuales
Â  Â  Â  et.querySelector(".nombreReactivo").textContent = info.nombre;
Â  Â  Â  et.querySelector(".preparacion").textContent = info.preparaciÃ³n || "No aplica";
Â  Â  Â  et.querySelector(".advertencia").textContent = info.palabra_advertencia || "â€”";
Â  Â  Â  et.querySelector(".analista").textContent = item.analista || "â€”";


      // =======================================
      // ğŸ”¥ FABRICANTE DINÃMICO PROFESIONAL
      // =======================================

      const fabricanteText = et.querySelector(".fabricante-text");
      const fabricanteWrapper = et.querySelector(".fabricante-wrapper");

      if (fabricanteText && fabricanteWrapper) {

          const nombreNormalizado = (item.nombreReactivo || "")
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "")
              .toLowerCase();

          const esReenvasado =
              nombreNormalizado.includes("reenvasado") ||
              nombreNormalizado.includes("reenvasada");

          let infoCompleta = "";


          if (esReenvasado) {

              const fabricante = info.fabricanteFiltrado || item.fabricante || "";
              const direccion = info.direccion || "";
              const telefono = info.telefono || "";

              infoCompleta = fabricante;
              if (direccion) infoCompleta += " - " + direccion;
              if (telefono) infoCompleta += " - Tel: " + telefono;

          }

          else if (item.soloPuros) {

                const fabricante = info.fabricanteFiltrado || "";
                const direccion = info.direccion || "";
                const telefono = info.telefono || "";

                infoCompleta = fabricante;
                if (direccion) infoCompleta += " - " + direccion;
                if (telefono) infoCompleta += " - Tel: " + telefono;

          }
          else {

              infoCompleta = "SGI SAS - Cra. 32B #22B-29 - Tel: 3142742383";
          }

          fabricanteText.textContent = infoCompleta || "Proveedor no definido";


          // ğŸ”¥ Escalado proporcional automÃ¡tico (sin cortar texto)
          requestAnimationFrame(() => {

          const textWidth = fabricanteText.scrollWidth;
          const containerWidth = fabricanteWrapper.offsetWidth;

          if (textWidth > containerWidth) {

              let scale = containerWidth / textWidth;

              if (scale < 0.65) scale = 0.65; // lÃ­mite mÃ­nimo elegante

              fabricanteText.style.transform = `scale(${scale})`;

          } else {

              fabricanteText.style.transform = "scale(1)";
          }

      });

}




Â  Â  Â  let htmlHP = "";
Â  Â  Â  info.frases_h?.forEach(f => htmlHP += `<p>${f}</p>`);
Â  Â  Â  info.frases_p?.forEach(f => htmlHP += `<p>${f}</p>`);
Â  Â  Â  et.querySelector(".frasesHP").innerHTML = htmlHP;

Â  Â  Â  if (info.imagenPictograma) {
Â  Â  Â  Â  et.querySelector(".zonaPictogramas")
Â  Â  Â  Â  Â  .innerHTML = `<img src="${info.imagenPictograma}" class="img-pictograma">`;
Â  Â  Â  }

Â  Â  Â  // --- AQUÃ ASIGNAMOS EL QR QUE TRAJIMOS DEL SERVIDOR ---
Â  Â  Â  if (qrBase64) {
Â  Â  Â  Â  Â  et.querySelector(".qr").src = qrBase64;
Â  Â  Â  }
Â  Â  Â  // ------------------------------------------------------

Â  Â  Â  // Fechas
Â  Â  Â  if (!item.incluirFechas) {
Â  Â  Â  Â  et.querySelector(".fechaPreparado").style.display = "none";
Â  Â  Â  Â  et.querySelector(".fechaVencimiento").style.display = "none";
Â  Â  Â  } else {
Â  Â  Â  Â  const hoy = new Date();
Â  Â  Â  Â  et.querySelector(".fechaPreparado").textContent =
Â  Â  Â  Â  Â  hoy.toLocaleDateString("es-CO");

Â  Â  Â  Â  let venc = new Date(hoy);
Â  Â  Â  Â  // ConversiÃ³n segura a nÃºmero
Â  Â  Â  Â  const valorVigencia = parseInt(item.vigenciaValor) || 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  switch (item.vigenciaUnidad) {
Â  Â  Â  Â  Â  case "DÃ­a(s)": venc.setDate(venc.getDate() + valorVigencia); break;
Â  Â  Â  Â  Â  case "Semana(s)": venc.setDate(venc.getDate() + 7 * valorVigencia); break;
Â  Â  Â  Â  Â  case "Mes(es)": venc.setMonth(venc.getMonth() + valorVigencia); break;
Â  Â  Â  Â  Â  case "AÃ±o(s)": venc.setFullYear(venc.getFullYear() + valorVigencia); break;
Â  Â  Â  Â  }
Â  Â  Â  Â  et.querySelector(".fechaVencimiento").textContent =Â 
Â  Â  Â  Â  Â  venc.toLocaleDateString("es-CO");
Â  Â  Â  }

Â  Â  Â  contenedor.appendChild(et);
Â  Â  }
Â  }
Â Â 
Â  setStatus("Etiquetas listas. Revisa los QRs y haz clic en 'Generar archivo DOCX'.", false); // Usando setStatus
}

cargarEtiquetas();



document.getElementById("btnGenerarDOCX").addEventListener("click", async () => {
Â  Â  // 1. Obtener todos los elementos de etiqueta renderizados
Â  Â  const etiquetasDOM = [...document.querySelectorAll(".etiqueta")];

Â  Â  if (etiquetasDOM.length === 0) {
Â  Â  Â  setStatus("No hay etiquetas para convertir.", true); // Usando setStatus
Â  Â  Â  return;
Â  Â  }

Â  Â  setStatus("Procesando etiquetasâ€¦", false); // Usando setStatus
Â  Â Â 
Â  Â  // Asumo que 'window.datos' contiene el array de reactivos con 'envase' y 'copias'.
Â  Â  if (!window.datos) {
Â  Â  Â  Â  setStatus("Error: No se encontraron los datos de los reactivos ('window.datos').", true); // Usando setStatus
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const payloadEtiquetas = [];
Â  Â  let etiquetasIndex = 0;

Â  Â  // Recorrer los datos originales para obtener el 'envase' correcto
Â  Â  for (const item of window.datos) {
Â  Â  Â  Â  const copias = item.copias || 1;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Iterar por cada copia generada por este formulario
Â  Â  Â  Â  for (let c = 0; c < copias; c++) {
Â  Â  Â  Â  Â  Â  const et = etiquetasDOM[etiquetasIndex]; // Obtener el elemento DOM en el orden correcto
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!et) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Faltan elementos DOM para la etiqueta #", etiquetasIndex);
Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 2. Usar html2canvas para tomar la 'foto' (screenshot)
Â  Â  Â  Â  Â  Â  const canvas = await html2canvas(et, { scale: 2, background: '#fff' });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Crear el objeto con la imagen y el envase para el backend
Â  Â  Â  Â  Â  Â  payloadEtiquetas.push({
Â  Â  Â  Â  Â  Â  Â  Â  base64Image: canvas.toDataURL("image/png").replace(/^data:image\/png;base64,/, ""),
Â  Â  Â  Â  Â  Â  Â  Â  envase: item.envaseÂ 
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  etiquetasIndex++;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // 4. Enviar el nuevo payload ({ etiquetas: [...] }) al backend
Â  Â  const res = await fetch(`${API_URL}/api/generarDocumentoMultiples`, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: { "Content-Type": "application/json", "ngrok-skip-browser-warning": "true" },
Â  Â  Â  Â  // ğŸ‘ˆ CAMBIO AQUÃ: Enviar un objeto con la clave 'etiquetas'
Â  Â  Â  Â  body: JSON.stringify({ etiquetas: payloadEtiquetas })
Â  Â  });

Â  Â  const data = await res.json();

Â  Â  if (data.ok) {
Â  Â  Â  Â  window.__archivoFinal = data.archivo;
Â  Â  Â  Â  setStatus("Documento generado correctamente. Usa 'Descargar archivo'.", false); // Usando setStatus
Â  Â  } else {
Â  Â  Â  Â  setStatus(`Error generando documento: ${data.error || 'Desconocido'}`, true); // Usando setStatus
Â  Â  }
});

/* =====================================================
Â  Â DESCARGAR ARCHIVO FINAL
===================================================== */
document.getElementById("btnDescargar").addEventListener("click", async () => {
Â  Â  // const statusEl = document.getElementById("status"); // << YA ESTÃ DEFINIDO Y NO SE NECESITA REPETIR AQUÃ

Â  Â  if (!window.__archivoFinal) {
Â  Â  Â  Â  setStatus("Primero genera el documento.", true); // Usando setStatus
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  setStatus("Iniciando descarga del archivo...", false); // Usando setStatus


Â  Â  const archivoADescargar = window.__archivoFinal;
Â  Â  const urlDescarga = `${API_URL}/api/descargar/${archivoADescargar}`;
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  // 1. Usar FETCH para incluir el encabezado de ngrok
Â  Â  Â  Â  const response = await fetch(urlDescarga, {
Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  Â  Â  Â  Â  headers: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Encabezado CLAVE para evitar la pÃ¡gina de advertencia de ngrok
Â  Â  Â  Â  Â  Â  Â  Â  'ngrok-skip-browser-warning': 'true'Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  setStatus(`Error ${response.status} al descargar el archivo.`, true); // Usando setStatus
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Procesar la respuesta binaria (Blob)
Â  Â  Â  Â  const blob = await response.blob();

Â  Â  Â  Â  // 3. Crear un enlace temporal para forzar la descarga en el navegador
Â  Â  Â  Â  const url = window.URL.createObjectURL(blob);
Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  a.download = archivoADescargar; // Usa el nombre de archivo final
Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  a.click();
Â  Â  Â  Â  a.remove(); // Limpiar el elemento

Â  Â  Â  Â  // 4. Liberar el objeto URL creado
Â  Â  Â  Â  window.URL.revokeObjectURL(url);

Â  Â  Â  Â  setStatus("Archivo descargado.", false); // Usando setStatus

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error en la descarga:", error);
Â  Â  Â  Â  setStatus("Fallo la descarga. Revisa la consola.", true); // Usando setStatus
Â  Â  }
});

</script>

</body>
</html>
