<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generar Etiqueta</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #eef2fb;
      color: #1e1e1e;
    }

    .hero {
      background: linear-gradient(135deg, #000000, #003d99);
      color: #b7d9ff;
      padding: 60px 40px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      border-bottom: 3px solid #007bff;
    }

    .hero h1 {
      font-size: 42px;
      font-weight: bold;
      text-shadow: 0 0 10px #008cff;
      margin: 0;
    }

    .container {
      max-width: 700px;
      margin: 40px auto;
      background: #ffffff;
      padding: 35px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border: 1px solid #dfe6f5;
    }

    h2 {
      color: #004a99;
      font-size: 26px;
      margin-top: 0;
    }

    label {
      font-weight: bold;
      margin-bottom: 6px;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #c9c9c9;
      border-radius: 6px;
      background: #f9f9f9;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    button {
      background: #007bff;
      padding: 14px 26px;
      border: none;
      width: 100%;
      color: #fff;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    button:hover {
      background: #0066dd;
      transform: scale(1.03);
    }

    .checkbox {
      display: flex;
      align-items: center;
    }

    #listaReactivos {
      position: absolute;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      width: calc(100% - 2px);
      z-index: 1000;
      display: none;
    }

    .reactivo-opcion {
      padding: 10px;
      cursor: pointer;
    }

    .reactivo-opcion:hover {
      background: #e6f0ff;
    }
  </style>

</head>
<body>

  <div class="hero">
    <h1>Generar Etiqueta</h1>
    <!-- BOT√ìN IR A M√öLTIPLES ETIQUETAS -->
    <div style="
       margin-top: 25px;
       display: flex;
       justify-content: center;
    ">
      <a href="multiindex.html" 
         style="
           text-decoration: none;
           background: #0056d6;
           color: white;
           padding: 12px 20px;
           border-radius: 8px;
           font-size: 18px;
           font-weight: bold;
           box-shadow: 0 4px 10px rgba(0,0,0,0.3);
           display: flex;
           align-items: center;
           gap: 10px;
          ">
         <span style="font-size: 22px;">üì¶</span>
         Generar m√∫ltiples etiquetas
      </a>
    </div>

  </div>

  <div class="container">
    <h2>Datos del Reactivo</h2>

    <!-- AUTOCOMPLETE -->
    <label>Nombre del reactivo:</label>
    <div style="position: relative;">
      <input type="text" id="inputReactivo" autocomplete="off" />
      <div id="listaReactivos"></div>
    </div>

    <label>Iniciales del responsable:</label>
    <input type="text" id="inputAnalista"/>

    <label>√Årea de trabajo:</label>
    <input type="text" id="inputArea"/>

    <label>Tiempo de vigencia:</label>
    <div class="row">
      <input type="number" id="vigenciaValor"/>
      <select id="vigenciaUnidad">
        <option>D√≠a(s)</option>
        <option>Semana(s)</option>
        <option>Mes(es)</option>
        <option>A√±o(s)</option>
      </select>
    </div>

    <label>Seleccione el fabricante:</label>
    <select id="fabricante">
      <option value="">-- Seleccione --</option>
      <option>MERCK</option>
      <option>PANREAC</option>
      <option>ACCUSTANDARD</option>
      <option>ACROS ORGANICS</option>
      <option>ALFA AESAR</option>
      <option>BIOPHARCHEM</option>
      <option>CARLO ERBA</option>
      <option>CDH</option>
      <option>CHEMI</option>
      <option>CIACOMEQ</option>
      <option>EKI</option>
      <option>FERMONT</option>
      <option>FISHER CHEMICAL</option>
      <option>HACH</option>
      <option>HANNA</option>
      <option>HONEYWELL</option>
      <option>J.T.BAKER</option>
      <option>LABKEM</option>
      <option>LOBA CHEMIE</option>
      <option>MOL LABS</option>
      <option>QUINALTEC</option>
      <option>RESTEK</option>
      <option>SIGMA-ALDRICH</option>
      <option>THERMO FISHER</option>
      <option>VHG</option>
      <option>QUIMMEN</option>
      <option>HIMEDIA</option>
      <option>TIMSEN</option>
    </select>

    <label>Seleccione el envase:</label>
    <select id="envase">
      <option value="">-- Seleccione --</option>
      <option>30 mL</option>
      <option>40 mL</option>
      <option>60 mL</option>
      <option>100 mL</option>
      <option>250 mL</option>
      <option>500 mL</option>
      <option>1000 mL</option>
      <option>2000 mL</option>
      <option>3000 mL</option>
      <option>10 L</option>
      <option>20 L</option>
      <option>30 L</option>
      <option>40 L</option>
      <option>50 L</option>
    </select>

    <div class="checkbox">
      <input type="checkbox" id="check" />
      <label for="check" style="margin-left:6px;">Incluir fechas en la etiqueta</label>
    </div>

    <button id="btnGenerar">Generar Etiqueta</button>
  </div>

<script type="module">
  const API_URL="https://48a2310b9a11.ngrok-free.app";
  const inputReactivo = document.getElementById("inputReactivo");
  const lista = document.getElementById("listaReactivos");

  let reactivos = [];

  // ============================
  // CARGAR NOMBRES DESDE INFOSOLUCIONESDBB
  // ============================
  async function cargarReactivos() {
    try {
      const res = await fetch(`${API_URL}/api/listaReactivos`);
      reactivos = await res.json(); // devuelve lista de strings
    } catch (e) {
      console.error("No se pudo cargar la lista de reactivos:", e);
    }
  }

  cargarReactivos();

  // ============================
  // AUTOCOMPLETE
  // ============================
  inputReactivo.addEventListener("input", () => {
    const texto = inputReactivo.value.toLowerCase();
    lista.innerHTML = "";

    if (!texto) {
      lista.style.display = "none";
      return;
    }

    const filtrados = reactivos.filter(nombre =>
      nombre.toLowerCase().includes(texto)
    );

    filtrados.slice(0, 20).forEach(nombre => {
      const div = document.createElement("div");
      div.className = "reactivo-opcion";
      div.textContent = nombre;

      div.addEventListener("click", () => {
        inputReactivo.value = nombre;
        lista.style.display = "none";
      });

      lista.appendChild(div);
    });

    lista.style.display = filtrados.length ? "block" : "none";
  });

  document.addEventListener("click", e => {
    if (!lista.contains(e.target) && e.target !== inputReactivo) {
      lista.style.display = "none";
    }
  });

  // ============================
  // GENERAR ETIQUETA
  // ============================
  document.getElementById("btnGenerar").addEventListener("click", async () => {

    const datosUsuario = {
      nombreReactivo: inputReactivo.value.trim(),
      analista: document.getElementById("inputAnalista").value.trim(),
      area: document.getElementById("inputArea").value.trim(),
      vigenciaValor: document.getElementById("vigenciaValor").value.trim(),
      vigenciaUnidad: document.getElementById("vigenciaUnidad").value.trim(),
      fabricante: document.getElementById("fabricante").value.trim(),
      envase: document.getElementById("envase").value.trim(), // <--- ESTE ES EL VOLUMEN
      incluirFechas: document.getElementById("check").checked
    };

    if (!datosUsuario.nombreReactivo)
      return alert("Debe seleccionar un reactivo");

    if (!datosUsuario.fabricante)
      return alert("Debe seleccionar un fabricante");

    // 1Ô∏è‚É£ Buscar datos de reactivo en backend
    try {
        const res = await fetch(`${API_URL}/api/generarEtiqueta`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nombreReactivo: datosUsuario.nombreReactivo,
            fabricante: datosUsuario.fabricante,
            volumen: datosUsuario.envase // <--- ¬°AGREGAR ESTA L√çNEA!
          })
        });

        if (!res.ok) {
             // Si el servidor responde con error (404, 500), leemos el mensaje
             const errorData = await res.json();
             alert(errorData.error || "Error al generar etiqueta");
             return;
        }

        const datosReactivo = await res.json();

        // 2Ô∏è‚É£ Guardar en sessionStorage
        sessionStorage.setItem("datosEtiqueta", JSON.stringify({
          usuario: datosUsuario,
          reactivo: datosReactivo
        }));

        // 3Ô∏è‚É£ Ir a etiqueta.html
        window.location.href = "etiqueta.html";

    } catch (error) {
        console.error(error);
        alert("Error de conexi√≥n con el servidor. Revisa que la terminal est√© abierta.");
    }
  });

</script>

</body>
</html>
