<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generar Etiqueta</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #eef2fb;
            color: #1e1e1e;
        }

        .hero {
            background: linear-gradient(135deg, #000000, #003d99);
            color: #b7d9ff;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border-bottom: 3px solid #007bff;
        }

        .hero h1 {
            font-size: 42px;
            font-weight: bold;
            text-shadow: 0 0 10px #008cff;
            margin: 0;
        }

        .container {
            max-width: 700px;
            margin: 40px auto;
            background: #ffffff;
            padding: 35px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid #dfe6f5;
        }

        h2 {
            color: #004a99;
            font-size: 26px;
            margin-top: 0;
        }

        label {
            font-weight: bold;
            margin-bottom: 6px;
            display: block;
        }

        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #c9c9c9;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .row {
            display: flex;
            gap: 10px;
        }

        button {
            background: #007bff;
            padding: 14px 26px;
            border: none;
            width: 100%;
            color: #fff;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        button:hover {
            background: #0066dd;
            transform: scale(1.03);
        }

        .checkbox {
            display: flex;
            align-items: center;
        }

        #listaReactivos {
            position: absolute;
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 2px);
            z-index: 1000;
            display: none;
        }

        .reactivo-opcion {
            padding: 10px;
            cursor: pointer;
        }

        .reactivo-opcion:hover {
            background: #e6f0ff;
        }
    </style>

</head>
<body>

    <div class="hero">
        <h1>Generar Etiqueta</h1>
        <div style="
            margin-top: 25px;
            display: flex;
            justify-content: center;
        ">
            <a href="multiindex.html" 
                style="
                    text-decoration: none;
                    background: #0056d6;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 18px;
                    font-weight: bold;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    ">
                <span style="font-size: 22px;">üì¶</span>
                Generar m√∫ltiples etiquetas
            </a>
        </div>
    </div>

    <div class="container">
        <h2>Datos del Reactivo</h2>

        <label>Nombre del reactivo:</label>
        <div style="position: relative;">
            <input type="text" id="inputReactivo" autocomplete="off" />
            <div id="listaReactivos"></div>
        </div>

        <label>Iniciales del responsable:</label>
        <input type="text" id="inputAnalista"/>

        <label>√Årea de trabajo:</label>
        <input type="text" id="inputArea"/>

        <label>Tiempo de vigencia:</label>
        <div class="row">
            <input type="number" id="vigenciaValor"/>
            <select id="vigenciaUnidad">
                <option>D√≠a(s)</option>
                <option>Semana(s)</option>
                <option>Mes(es)</option>
                <option>A√±o(s)</option>
            </select>
        </div>

        <label id="labelFabricante">Seleccione el fabricante:</label>
        <select id="fabricante">
            <option value="">-- Seleccione --</option>
            <option>SGI SAS</option>
            <option>MERCK</option>
            <option>PANREAC</option>
            <option>ACCUSTANDARD</option>
            <option>ACROS ORGANICS</option>
            <option>ALFA AESAR</option>
            <option>BIOPHARCHEM</option>
            <option>CARLO ERBA</option>
            <option>CDH</option>
            <option>CHEMI</option>
            <option>CIACOMEQ</option>
            <option>EKI</option>
            <option>FERMONT</option>
            <option>FISHER CHEMICAL</option>
            <option>HACH</option>
            <option>HANNA</option>
            <option>HONEYWELL</option>
            <option>J.T.BAKER</option>
            <option>LABKEM</option>
            <option>LOBA CHEMIE</option>
            <option>MOL LABS</option>
            <option>QUINALTEC</option>
            <option>RESTEK</option>
            <option>SIGMA-ALDRICH</option>
            <option>THERMO FISHER</option>
            <option>VHG</option>
            <option>QUIMMEN</option>
            <option>HIMEDIA</option>
            <option>TIMSEN</option>
        </select>

        <label>Seleccione el envase:</label>
        <select id="envase">
            <option value="">-- Seleccione --</option>
            <option value="30">30 mL</option> 
            <option value="40">40 mL</option>
            <option value="60">60 mL</option>
            <option value="100">100 mL</option>
            <option value="250">250 mL</option>
            <option value="500">500 mL</option>
            <option value="1000">1000 mL</option>
            <option value="2000">2000 mL</option>
            <option value="3000">3000 mL</option>
            <option value="10000">10 L</option> <option value="20000">20 L</option>
            <option value="30000">30 L</option>
            <option value="40000">40 L</option>
            <option value="50000">50 L</option>
        </select>

        <div class="checkbox">
            <input type="checkbox" id="check" />
            <label for="check" style="margin-left:6px;">Incluir fechas en la etiqueta</label>
        </div>

        <button id="btnGenerar">Generar Etiqueta</button>
    </div>

<script type="module">
    import { API_URL } from "./config.js";

    const inputReactivo = document.getElementById("inputReactivo");
    const lista = document.getElementById("listaReactivos");
    const labelFabricante = document.getElementById("labelFabricante");
    
    // Almacena objetos: [{ nombre: "...", codigo: "..." }, ...]
    let reactivos = []; 
    let reactivoSeleccionadoCodigo = null;

    /**
     * Actualiza el texto del label del fabricante.
     * @param {string} codigo - El c√≥digo a mostrar.
     */
    function actualizarLabelFabricante(codigo) {
        if (labelFabricante) {
            labelFabricante.textContent = `Seleccione el fabricante para "${codigo}":`;
        }
    }

    // =========================================================
    // CORRECCI√ìN DE CACHE DEL QR (Fuerza recarga al usar bot√≥n Atr√°s)
    // =========================================================
    window.addEventListener("pageshow", function(event) {
        if (event.persisted) {
            console.log("Regreso detectado (Atr√°s). Recargando para limpiar cach√©...");
            window.location.reload();
        }
    });

    // ============================
    // CARGAR NOMBRES DESDE API
    // (Requiere que el backend devuelva [{ nombre, codigo }, ...])
    // ============================
    async function cargarReactivos() {
        try {
            const res = await fetch(`${API_URL}/api/listaReactivos`, {
                headers: {
                    "ngrok-skip-browser-warning": "true"
                }
            });
            reactivos = await res.json(); 
            // Inicializa el label con un texto por defecto
            actualizarLabelFabricante("c√≥digo"); 
        } catch (e) {
            console.error("No se pudo cargar la lista de reactivos:", e);
        }
    }

    cargarReactivos();

    // ============================
    // AUTOCOMPLETE
    // ============================
    inputReactivo.addEventListener("input", () => {
        const texto = inputReactivo.value.toLowerCase();
        lista.innerHTML = "";

        // Resetear el c√≥digo y el label si se est√° escribiendo o el campo est√° vac√≠o
        reactivoSeleccionadoCodigo = null;
        actualizarLabelFabricante("c√≥digo");

        if (!texto) {
            lista.style.display = "none";
            return;
        }

        // Filtrar por la propiedad 'nombre'
        const filtrados = reactivos.filter(r =>
¬† ¬† ¬† ¬† ¬† ¬† // FIX: Comprobamos que el objeto 'r' existe y que 'r.nombre' es un string v√°lido
¬† ¬† ¬† ¬† ¬† ¬† r && typeof r.nombre === 'string' && r.nombre.toLowerCase().includes(texto)
¬† ¬† ¬† ¬† );

        filtrados.slice(0, 20).forEach(reactivo => {
            const div = document.createElement("div");
            div.className = "reactivo-opcion";
            div.textContent = reactivo.nombre;

            div.addEventListener("click", () => {
                inputReactivo.value = reactivo.nombre;
                lista.style.display = "none";
                
                // Al seleccionar, guarda el c√≥digo y actualiza el label
                reactivoSeleccionadoCodigo = reactivo.codigo;
                actualizarLabelFabricante(reactivo.codigo);
            });

            lista.appendChild(div);
        });

        lista.style.display = filtrados.length ? "block" : "none";
    });

    document.addEventListener("click", e => {
        if (!lista.contains(e.target) && e.target !== inputReactivo) {
            lista.style.display = "none";
        }
    });

    // ============================
    // GENERAR ETIQUETA
    // ============================
    document.getElementById("btnGenerar").addEventListener("click", async () => {

        const datosUsuario = {
            nombreReactivo: inputReactivo.value.trim(),
            analista: document.getElementById("inputAnalista").value.trim(),
            area: document.getElementById("inputArea").value.trim(),
            vigenciaValor: document.getElementById("vigenciaValor").value.trim(),
            vigenciaUnidad: document.getElementById("vigenciaUnidad").value.trim(),
            fabricante: document.getElementById("fabricante").value.trim(),
            envase: document.getElementById("envase").value.trim(), 
            incluirFechas: document.getElementById("check").checked
        };

        if (!datosUsuario.nombreReactivo)
            return alert("Debe seleccionar un reactivo");

        if (!datosUsuario.fabricante)
            return alert("Debe seleccionar un fabricante");
        
        if (!datosUsuario.envase)
            return alert("Debe seleccionar el tama√±o del envase");

        // 1Ô∏è‚É£ Buscar datos de reactivo en backend
        try {
            const res = await fetch(`${API_URL}/api/generarEtiqueta`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "ngrok-skip-browser-warning": "true" },
                body: JSON.stringify({
                    nombreReactivo: datosUsuario.nombreReactivo,
                    fabricante: datosUsuario.fabricante,
                    volumen: datosUsuario.envase 
                })
            });

            if (!res.ok) {
                const errorData = await res.json();
                alert(errorData.error || "Error al generar etiqueta");
                return;
            }

            const datosReactivo = await res.json();

            // 2Ô∏è‚É£ Guardar en sessionStorage
            sessionStorage.setItem("datosEtiqueta", JSON.stringify({
                usuario: datosUsuario,
                reactivo: datosReactivo
            }));

            // 3Ô∏è‚É£ L√ìGICA DE REDIRECCI√ìN
            const volumenNumerico = parseInt(datosUsuario.envase); 

            if (volumenNumerico < 100) {
                // Envases peque√±os (30, 40, 60 mL)
                window.location.href = "miniet.html";
            } else {
                // Envases grandes (100 mL o m√°s)
                window.location.href = "etiqueta.html";
            }

        } catch (error) {
            console.error(error);
            alert("Error de conexi√≥n con el servidor. Revisa que la terminal est√© abierta.");
        }
    });

</script>

</body>
</html>