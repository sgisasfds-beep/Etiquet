<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Generar M√∫ltiples Etiquetas</title>

    <style>
        /* ======== MISMO ESTILO BASE DE index.html ======== */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #eef2fb;
            color: #1e1e1e;
        }

        .hero {
            background: linear-gradient(135deg, #000000, #003d99);
            color: #b7d9ff;
            padding: 40px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border-bottom: 3px solid #007bff;
        }

        .hero h1 {
            font-size: 36px;
            font-weight: bold;
            text-shadow: 0 0 10px #008cff;
            margin: 0;
        }

        /* ======== CONTENEDOR ======== */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            background: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid #dfe6f5;
        }

        /* ======== FORM ======== */
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
        }

        input, select {
            padding: 12px;
            border: 1px solid #c9c9c9;
            border-radius: 6px;
            background: #f9f9f9;
            width: 100%;
        }

        label {
            font-weight: bold;
            margin-bottom: 4px;
            display: block;
        }

        .grid-forms {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        .form-card {
            padding: 16px;
            border: 1px solid #dfe6f5;
            border-radius: 8px;
            background: #fafafa;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        .form-row {
            margin-bottom: 12px;
        }

        button {
            background: #007bff;
            padding: 14px 26px;
            border: none;
            color: #fff;
            font-size: 15px;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        button:hover {
            background: #0066dd;
            transform: scale(1.03);
        }

        button.secondary {
            background: #6c757d;
        }

        .note {
            margin-top: 16px;
            color: #666;
            font-size: 14px;
        }

        .actions {
            margin-top: 25px;
            text-align: center;
        }

        /* Autocomplete id√©ntico a index */
        .lista-autocomplete {
            position: absolute;
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 6px;
            max-height: 180px;
            overflow-y: auto;
            width: calc(100% - 2px);
            z-index: 9999;
            display: none;
        }

        .reactivo-opcion {
            padding: 10px;
            cursor: pointer;
        }

        .reactivo-opcion:hover {
            background: #e6f0ff;
        }
    </style>

</head>
<body>

    <div class="hero">
        <h1>Generar M√∫ltiples Etiquetas</h1>
    </div>

    <div class="container">

        <div class="controls">
            <label for="numEtiquetas">¬øCu√°ntas etiquetas diferentes necesitas?</label>
            <input id="numEtiquetas" type="number" min="1" value="1" style="width:120px">
            <button id="btnGenerarForm">Generar formularios</button>
            <button id="btnAgregar" class="secondary" type="button">Agregar 1</button>
        </div>

        <div id="formContainer" class="grid-forms"></div>

        <div class="note">Cada tarjeta corresponde a una etiqueta diferente.</div>

        <div class="actions">
            <button id="btnSiguiente">Siguiente ‚Üí Generar documento</button>
        </div>
    </div>

    <script type="module">
        import { API_URL } from "./config.js";

        /* ======================================
            üîµ CARGAR LISTA DE REACTIVOS
        ====================================== */

        window.addEventListener("pageshow", async () => {
            console.log("Recargando vista m√∫ltiple...");
            // L√≥gica para forzar repintado de im√°genes (mantener para compatibilidad)
            setTimeout(() => {
                document.querySelectorAll('img').forEach(img => {
                    const src = img.src;
                    img.src = '';
                    img.src = src;
                });
            }, 100);
        });

        let listaReactivosGlobal = [];

        async function cargarReactivos() {
            try {
                const res = await fetch(`${API_URL}/api/listaReactivos`, {
                    headers: {
                        "ngrok-skip-browser-warning": "true"
                    }
                });
                // ‚ùó IMPORTANTE: listaReactivosGlobal DEBE CONTENER OBJETOS { nombre, codigo } ‚ùó
                listaReactivosGlobal = await res.json();
            } catch (err) {
                console.error("Error cargando reactivos:", err);
            }
        }

        cargarReactivos();

        /* ======================================
            üîµ CREAR FORMULARIO INDIVIDUAL
        ====================================== */
        function crearFormulario(i) {

            const card = document.createElement("div");
            card.className = "form-card";
            card.dataset.index = i;

            const idLista = `listaReact_${i}`;
            const idInput = `reactivoInput_${i}`;
            // ‚ùó CAMBIO: ID DIN√ÅMICO PARA EL LABEL DEL FABRICANTE ‚ùó
            const idLabelFabricante = `labelFabricante_${i}`; 

            card.innerHTML = `
                <h3 style="margin-top:0;">Etiqueta #${i + 1}</h3>

                <label>Nombre del reactivo:</label>
                <div style="position:relative;">
                    <input id="${idInput}" class="fld nombreReactivo" autocomplete="off">
                    <div id="${idLista}" class="lista-autocomplete"></div>
                </div>

                <label>Iniciales del responsable:</label>
                <input class="fld analista">

                <label>√Årea de trabajo:</label>
                <input class="fld area">

                <label>Tiempo de vigencia:</label>
                <div class="form-row" style="display:flex; gap:12px;">
                    <input class="fld vigenciaValor" type="number" placeholder="Valor" style="width:80px;">
                    <select class="fld vigenciaUnidad">
                        <option>D√≠a(s)</option>
                        <option>Semana(s)</option>
                        <option>Mes(es)</option>
                        <option>A√±o(s)</option>
                    </select>
                </div>

                <label id="${idLabelFabricante}">Seleccione el fabricante para "c√≥digo":</label>
                <select class="fld fabricante">
                    <option value="">-- Seleccione --</option>
                    <option>SGI SAS</option>
                    <option>MERCK</option>
                    <option>PANREAC</option>
                    <option>ACCUSTANDARD</option>
                    <option>ACROS ORGANICS</option>
                    <option>ALFA AESAR</option>
                    <option>BIOPHARCHEM</option>
                    <option>CARLO ERBA</option>
                    <option>CDH</option>
                    <option>CHEMI</option>
                    <option>CIACOMEQ</option>
                    <option>EKI</option>
                    <option>FERMONT</option>
                    <option>FISHER CHEMICAL</option>
                    <option>HACH</option>
                    <option>HANNA</option>
                    <option>HONEYWELL</option>
                    <option>J.T.BAKER</option>
                    <option>LABKEM</option>
                    <option>LOBA CHEMIE</option>
                    <option>MOL LABS</option>
                    <option>QUINALTEC</option>
                    <option>RESTEK</option>
                    <option>SIGMA-ALDRICH</option>
                    <option>THERMO FISHER</option>
                    <option>VHG</option>
                    <option>QUIMMEN</option>
                    <option>HIMEDIA</option>
                    <option>TIMSEN</option>
                </select>

                <label>Seleccione envase:</label>
                <select class="fld envase">
                    <option value="">-- Seleccione --</option>
                    <option value="30">30 mL</option>
                    <option value="40">40 mL</option>
                    <option value="60">60 mL</option>
                    <option value="100">100 mL</option>
                    <option value="250">250 mL</option>
                    <option value="500">500 mL</option>
                    <option value="1000">1000 mL</option>
                    <option value="2000">2000 mL</option>
                    <option value="3000">3000 mL</option>
                    <option value="10000">10 L</option>
                    <option value="20000">20 L</option>
                    <option value="30000">30 L</option>
                    <option value="40000">40 L</option>
                    <option value="50000">50 L</option>
                </select>

                <label>Copias de esta etiqueta:</label>
                <input type="number" class="fld copias" min="1" value="1">

                <label style="display:flex;align-items:center; gap:8px; margin-top:10px;">
                    <input type="checkbox" class="fld incluirFechas"> Incluir fechas en etiqueta
                </label>
            `;
            
            // Elementos DOM de esta tarjeta
            const inputReactivo = card.querySelector(`#${idInput}`);
            const lista = card.querySelector(`#${idLista}`);
            // ‚ùó NUEVO: REFERENCIA AL LABEL DIN√ÅMICO ‚ùó
            const labelFabricante = card.querySelector(`#${idLabelFabricante}`); 
            
            /**
             * ‚ùó NUEVO: FUNCI√ìN LOCAL PARA ACTUALIZAR EL LABEL ‚ùó
             */
            function actualizarLabelFabricante(codigo) {
                if (labelFabricante) {
                    labelFabricante.textContent = `Seleccione el fabricante para "${codigo}":`;
                }
            }


            /* ============================ ¬†
                AUTOCOMPLETE INDIVIDUAL ¬†
            ============================ */
            inputReactivo.addEventListener("input", () => {
                const texto = inputReactivo.value.toLowerCase();
                lista.innerHTML = "";

                // ‚ùó CAMBIO: RESETEAR C√ìDIGO Y LABEL AL ESCRIBIR ‚ùó
                card.dataset.codigoReactivo = null;
                actualizarLabelFabricante("c√≥digo");

                if (!texto) {
                    lista.style.display = "none";
                    return;
                }

                // ‚ùó CAMBIO: FILTRAR USANDO LA PROPIEDAD 'nombre' del objeto reactivo ‚ùó
                const filtrados = listaReactivosGlobal.filter(r =>
                    r.nombre.toLowerCase().includes(texto)
                );

                // ‚ùó CAMBIO: RECORRER OBJETOS (reactivo) EN LUGAR DE SOLO STRINGS ‚ùó
                filtrados.slice(0, 20).forEach(reactivo => { 
                    const div = document.createElement("div");
                    div.className = "reactivo-opcion";
                    div.textContent = reactivo.nombre;

                    div.addEventListener("click", () => {
                        inputReactivo.value = reactivo.nombre;
                        lista.style.display = "none";
                        
                        // ‚ùó CAMBIO: GUARDAR C√ìDIGO Y ACTUALIZAR LABEL AL SELECCIONAR ‚ùó
                        card.dataset.codigoReactivo = reactivo.codigo;
                        actualizarLabelFabricante(reactivo.codigo);
                    });

                    lista.appendChild(div);
                });

                lista.style.display = filtrados.length ? "block" : "none";
            });

            // Ajuste del cierre de lista
            document.addEventListener("click", (e) => {
                if (e.target !== inputReactivo && !lista.contains(e.target)) {
                    lista.style.display = "none";
                }
            });

            return card;
        }

        /* ======================================
            üîµ GENERAR FORMULARIOS
        ====================================== */
        const formContainer = document.getElementById("formContainer");

        function generarNForms(n) {
            formContainer.innerHTML = "";
            for (let i = 0; i < n; i++) {
                formContainer.appendChild(crearFormulario(i));
            }
        }

        document.getElementById("btnGenerarForm").addEventListener("click", () => {
            generarNForms(Number(document.getElementById("numEtiquetas").value || 1));
        });

        document.getElementById("btnAgregar").addEventListener("click", () => {
            const index = formContainer.children.length;
            formContainer.appendChild(crearFormulario(index));
            document.getElementById("numEtiquetas").value = formContainer.children.length;
        });

        /* ======================================
            üîµ BOT√ìN SIGUIENTE
        ====================================== */
        document.getElementById("btnSiguiente").addEventListener("click", () => {

            const cards = [...formContainer.children];
            const etiquetas = [];

            for (const c of cards) {
                const nombre = c.querySelector(".nombreReactivo").value.trim();
                // ‚ùó NUEVO: OBTENER EL C√ìDIGO DEL DATASET ‚ùó
                const codigoReactivo = c.dataset.codigoReactivo;

                if (!nombre) {
                    alert("Cada etiqueta debe tener un nombre de reactivo.");
                    return;
                }
                
                // ‚ùó NUEVO: VALIDAR QUE SE HAYA SELECCIONADO UN C√ìDIGO ‚ùó
                if (!codigoReactivo) {
                    alert(`Debes seleccionar un reactivo v√°lido de la lista en la etiqueta #${parseInt(c.dataset.index) + 1} para obtener su c√≥digo.`);
                    return;
                }

                etiquetas.push({
                    nombreReactivo: nombre,
                    codigoReactivo: codigoReactivo, // ‚ùó NUEVO CAMPO A ENVIAR ‚ùó
                    analista: c.querySelector(".analista").value.trim(),
                    area: c.querySelector(".area").value.trim(),
                    vigenciaValor: c.querySelector(".vigenciaValor").value.trim(),
                    vigenciaUnidad: c.querySelector(".vigenciaUnidad").value,
                    fabricante: c.querySelector(".fabricante").value.trim(),
                    envase: c.querySelector(".envase").value.trim(),
                    incluirFechas: c.querySelector(".incluirFechas").checked,
                    copias: parseInt(c.querySelector(".copias").value || "1")
                });
            }

            sessionStorage.setItem("multiEtiquetas_datos", JSON.stringify(etiquetas));

            window.location.href = "multiEtiqueta.html";
        });

    </script>

</body>
</html>